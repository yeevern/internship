FROM node:20-alpine as base

ARG AWS_ACCESS_KEY_ID
ARG AWS_REGION
ARG AWS_SECRET_ACCESS_KEY
ARG COGNITO_CLIENT_ID
ARG COGNITO_CLIENT_SECRET
ARG COGNITO_USERPOOL_ID
ARG DYNAMO_EVENTS
ARG DYNAMO_PROJECTS
ARG DYNAMO_SURVEY_MODELS
ARG DYNAMO_SURVEYS
ARG DYNAMO_PROFILES
ARG DYNAMO_TRANSACTIONS
ARG NEXTAUTH_URL
ARG NEXTAUTH_SECRET
ARG NEXT_PUBLIC_COGNITO_SIGNOUT_URL

# Dependency layer
FROM base as deps
# RUN apk add --no-cache libc6-compat
RUN npm install -g npm@10.2.3

WORKDIR /netizen
COPY package*.json ./
RUN npm ci

# Build layer
FROM base as builder
WORKDIR /netizen
COPY --from=deps /netizen/node_modules ./node_modules
COPY . .

ENV NEXT_TELEMETRY_DISABLED 1

ENV AWS_ACCESS_KEY_ID $AWS_ACCESS_KEY_ID
ENV AWS_SECRET_ACCESS_KEY $AWS_SECRET_ACCESS_KEY
ENV AWS_REGION $AWS_REGION
ENV COGNITO_CLIENT_ID $COGNITO_CLIENT_ID
ENV COGNITO_CLIENT_SECRET $COGNITO_CLIENT_SECRET
ENV COGNITO_USERPOOL_ID $COGNITO_USERPOOL_ID
ENV DYNAMO_EVENTS $DYNAMO_EVENTS
ENV DYNAMO_PROJECTS $DYNAMO_PROJECTS
ENV DYNAMO_SURVEY_MODELS $DYNAMO_SURVEY_MODELS
ENV DYNAMO_SURVEYS $DYNAMO_SURVEYS
ENV DYNAMO_PROFILES $DYNAMO_PROFILES
ENV DYNAMO_TRANSACTIONS $DYNAMO_TRANSACTIONS
ENV NEXTAUTH_URL $NEXTAUTH_URL
ENV NEXTAUTH_SECRET $NEXTAUTH_SECRET
ENV NEXT_PUBLIC_COGNITO_SIGNOUT_URL $NEXT_PUBLIC_COGNITO_SIGNOUT_URL

RUN npx nx reset
RUN npx nx run nanikore-website:build --configuration=production

# Runner layer
FROM base AS runner
WORKDIR /netizen

ENV NODE_ENV production
ENV NEXT_TELEMETRY_DISABLED 1

RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs

COPY --from=builder /netizen/apps/nanikore/website/public ./apps/nanikore/website/public

RUN mkdir ./apps/nanikore/website/.next 
RUN chown nextjs:nodejs ./apps/nanikore/website/.next

COPY --from=builder --chown=nextjs:nodejs /netizen/apps/nanikore/website/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /netizen/apps/nanikore/website/.next/static ./apps/nanikore/website/.next/static

USER nextjs

EXPOSE 3000

ENV AWS_ACCESS_KEY_ID $AWS_ACCESS_KEY_ID
ENV AWS_SECRET_ACCESS_KEY $AWS_SECRET_ACCESS_KEY
ENV AWS_REGION $AWS_REGION
ENV COGNITO_CLIENT_ID $COGNITO_CLIENT_ID
ENV COGNITO_CLIENT_SECRET $COGNITO_CLIENT_SECRET
ENV COGNITO_USERPOOL_ID $COGNITO_USERPOOL_ID
ENV DYNAMO_EVENTS $DYNAMO_EVENTS
ENV DYNAMO_PROJECTS $DYNAMO_PROJECTS
ENV DYNAMO_SURVEY_MODELS $DYNAMO_SURVEY_MODELS
ENV DYNAMO_SURVEYS $DYNAMO_SURVEYS
ENV DYNAMO_PROFILES $DYNAMO_PROFILES
ENV DYNAMO_TRANSACTIONS $DYNAMO_TRANSACTIONS
ENV NEXTAUTH_URL $NEXTAUTH_URL
ENV NEXTAUTH_SECRET $NEXTAUTH_SECRET
ENV NEXT_PUBLIC_COGNITO_SIGNOUT_URL $NEXT_PUBLIC_COGNITO_SIGNOUT_URL

RUN mkdir /home/nextjs/.aws
RUN echo "[default]" > /home/nextjs/.aws/credentials
RUN echo "aws_access_key_id = $AWS_ACCESS_KEY_ID" >> /home/nextjs/.aws/credentials
RUN echo "aws_secret_access_key=$AWS_SECRET_ACCESS_KEY" >> /home/nextjs/.aws/credentials

ENV PORT 3000
ENV HOSTNAME "0.0.0.0"

CMD ["node", "apps/nanikore/website/server.js"]